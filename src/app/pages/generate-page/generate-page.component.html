<div style="display: flex; width: 100%; min-height: 100vh;">
  <!-- Sidebar -->
  <div style="width: 260px; background: #f7f7fa; border-right: 1px solid #e0e0e0; flex-shrink: 0;">
    <div style="padding: 1.5rem 1rem 1rem 1rem;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
        <div style="font-weight: 600; font-size: 1.1rem;">Content Templates</div>
        <button mat-icon-button color="primary" (click)="createNewTemplate()" matTooltip="Create New Template">
          <mat-icon>add</mat-icon>
        </button>
      </div>
      <mat-nav-list>
        <a mat-list-item *ngFor="let t of templates" (click)="selectTemplate(t)" [class.selected]="t.id === templateId">
          <mat-icon matListItemIcon>description</mat-icon>
          <span matLine>{{ t.templateInfo?.name || 'Untitled' }}</span>
        </a>
        <div *ngIf="!templates.length" style="color: #888; font-size: 0.98em; margin-top: 1rem;">No templates found for this brand.</div>
      </mat-nav-list>
    </div>
  </div>
  <!-- Main form content -->
  <div style="flex: 1; padding: 2rem; max-width: 1000px; margin: 0 auto; box-sizing: border-box; background: #fff;">
    <ng-container *ngIf="brandId && templateData && templateData.templateInfo && templateData.settings && templateData.settings.promptTemplate; else emptyState">
      <div *ngIf="brandId">
        <mat-card>
          <mat-card-header>
            <mat-card-title>{{ templateId ? 'Edit Content Template' : 'Create Content Template' }}</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <form (ngSubmit)="templateId ? onUpdate() : onSubmit()">
              <div class="form-section">
                <h3>Template Info</h3>
                <div class="subtitle">Enter the basic details for your content template. These help you identify and organize your templates.</div>
                <div class="form-row">
                  <mat-form-field class="form-field" appearance="outline">
                    <mat-label>Template Name</mat-label>
                    <input matInput [(ngModel)]="templateData.templateInfo.name" name="templateName" maxlength="100" required>
                  </mat-form-field>
                  <mat-form-field class="form-field" appearance="outline">
                    <mat-label>Content Type</mat-label>
                    <mat-select [(ngModel)]="templateData.templateInfo.contentType" name="contentType" required>
                      <mat-option *ngFor="let type of supportedContentTypes" [value]="type">{{ type }}</mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
                <mat-form-field class="form-field" appearance="outline" style="width:100%;margin-top:1rem;">
                  <mat-label>Template Description</mat-label>
                  <textarea matInput [(ngModel)]="templateData.templateInfo.description" name="description" rows="2" maxlength="500"></textarea>
                </mat-form-field>
                <div class="form-row platform-row">
                  <div class="platform-label">Platforms</div>
                  <div class="platform-checkboxes">
                    <mat-checkbox *ngFor="let platform of supportedPlatforms; let i = index"
                        [checked]="(templateData.templateInfo.socialAccounts ?? []).includes(platform)"
                        (change)="togglePlatform(platform, $event.checked)"
                      [name]="'platformCheckbox' + i">
                      {{ platform.charAt(0).toUpperCase() + platform.slice(1) }}
                    </mat-checkbox>
                  </div>
                </div>
              </div>
              <!-- Content Section -->
              <div class="form-section">
                <h3>Prompt Settings</h3>
                <div class="subtitle">Configure the prompt that will be used for content generation, and define any variables that can be used in the prompt.</div>
                <mat-form-field class="form-field" appearance="outline" style="width:100%;margin-top:1rem;">
                  <mat-label>User Prompt</mat-label>
                  <textarea matInput [(ngModel)]="templateData.settings.promptTemplate.userPrompt" name="userPrompt" rows="2" maxlength="1000"></textarea>
                </mat-form-field>
                <div class="prompt-variables-section">
                  <div class="prompt-variables-header" style="display: flex; align-items: center; gap: 1rem;">
                    <span style="font-weight: 500;">Prompt Variables</span>
                  </div>
                  <button mat-stroked-button color="primary" type="button" (click)="addVariable()" style="margin: 1rem 0;">
                    <mat-icon>add</mat-icon> Add Variable
                  </button>
                  <div *ngFor="let variable of templateData.settings.promptTemplate.variables || []; let i = index" class="prompt-variable-row" style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1.5rem;">
                    <mat-form-field appearance="outline" style="min-width: 180px;">
                      <mat-label>Variable Name</mat-label>
                      <input matInput [(ngModel)]="variable.name" [name]="'variableName' + i" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" style="min-width: 280px; flex: 1;">
                      <mat-label>Values (comma separated)</mat-label>
                      <input matInput [(ngModel)]="variable.values" [name]="'variableValues' + i">
                    </mat-form-field>
                    <mat-form-field appearance="outline" style="min-width: 220px; flex: 1;">
                      <mat-label>Description</mat-label>
                      <input matInput [(ngModel)]="variable.description" [name]="'variableDescription' + i">
                    </mat-form-field>
                    <button mat-icon-button color="warn" type="button" (click)="removeVariable(i)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
              <!-- Visual Style Section (basic, only for existing properties) -->
              <div class="form-section">
                <h3>Visual Style Settings</h3>
                <div class="subtitle">Configure visual style settings for this template. (Advanced options may be available in code only)</div>
                <ng-container *ngIf="templateData.settings?.visualStyle?.themes?.length">
                  <div *ngFor="let theme of templateData.settings?.visualStyle?.themes; let tIdx = index" style="margin-bottom: 1rem;">
                    <mat-form-field class="form-field" appearance="outline" style="min-width: 180px;">
                      <mat-label>Background Color</mat-label>
                      <input matInput [(ngModel)]="theme.backgroundColor" [name]="'backgroundColor' + tIdx" placeholder="#FFFFFF">
                    </mat-form-field>
                    <!-- Add more controls for text_style, overlay_box, etc. as needed -->
                  </div>
                </ng-container>
                <div *ngIf="!templateData.settings?.visualStyle?.themes?.length" style="color: #888;">No visual style themes defined.</div>
              </div>
              <!-- Schedule Section -->
              <div class="form-section">
                <h3>Schedule</h3>
                <div class="subtitle">Set the days and time slots for content generation.</div>
                <div class="form-row">
                  <div class="days-of-week">
                    <mat-checkbox *ngFor="let day of daysOfWeekOptions; let i = index"
                      [checked]="templateData.schedule?.daysOfWeek?.includes(day.value)"
                      (change)="toggleDayOfWeek(day.value, $event.checked)"
                      [name]="'dayOfWeekCheckbox' + i">
                      {{ day.label }}
                    </mat-checkbox>
                  </div>
                </div>
                <div class="form-row">
                  <div *ngFor="let slot of templateData.schedule?.timeSlots; let i = index" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <mat-form-field appearance="outline" style="width: 80px;">
                      <mat-label>Hour</mat-label>
                      <input matInput type="number" [(ngModel)]="slot.hour" [name]="'hour' + i" min="0" max="23">
                    </mat-form-field>
                    <mat-form-field appearance="outline" style="width: 80px;">
                      <mat-label>Minute</mat-label>
                      <input matInput type="number" [(ngModel)]="slot.minute" [name]="'minute' + i" min="0" max="59">
                    </mat-form-field>
                    <mat-form-field appearance="outline" style="width: 160px;">
                      <mat-label>Timezone</mat-label>
                      <mat-select [(ngModel)]="slot.timezone" [name]="'timeZone' + i">
                        <mat-option *ngFor="let tz of timeZoneOptions" [value]="tz">{{ tz }}</mat-option>
                      </mat-select>
                    </mat-form-field>
                    <button mat-icon-button color="warn" type="button" (click)="removeTimeSlot(i)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                  <button mat-stroked-button color="primary" type="button" (click)="addTimeSlot()" style="margin-top: 0.5rem;">
                    <mat-icon>add</mat-icon> Add Time Slot
                  </button>
                </div>
              </div>
              <!-- Image Section -->
              <div class="form-section">
                <h3>Image Settings</h3>
                <div class="subtitle">Configure image properties for this template.</div>
                <mat-form-field class="form-field" appearance="outline">
                  <mat-label>Set URL</mat-label>
                  <input matInput [(ngModel)]="image.setUrl" name="imageSetUrl" placeholder="https://...">
                </mat-form-field>
                <mat-form-field class="form-field" appearance="outline">
                  <mat-label>Media Type</mat-label>
                  <mat-select [(ngModel)]="image.mediaType" name="imageMediaType">
                    <mat-option value="color">Color</mat-option>
                    <mat-option value="set">Set</mat-option>
                    <mat-option value="uploaded">Uploaded</mat-option>
                    <mat-option value="online">Online</mat-option>
                  </mat-select>
                </mat-form-field>
                <!-- VisualStyle is a nested object, so just show a placeholder for now -->
                <div style="margin-bottom: 1rem; color: #888;">Visual Style: (edit in advanced settings)</div>
                <div class="form-row">
                  <mat-form-field class="form-field" appearance="outline">
                    <mat-label>Width (px)</mat-label>
                    <input matInput type="number" [(ngModel)]="imageDimensions.width" name="imageWidth" min="1">
                  </mat-form-field>
                  <mat-form-field class="form-field" appearance="outline">
                    <mat-label>Height (px)</mat-label>
                    <input matInput type="number" [(ngModel)]="imageDimensions.height" name="imageHeight" min="1">
                  </mat-form-field>
                  <mat-form-field class="form-field" appearance="outline">
                    <mat-label>Aspect Ratio</mat-label>
                    <mat-select [(ngModel)]="imageDimensions.aspectRatio" name="imageAspectRatio">
                      <mat-option *ngFor="let ratio of imageAspectRatios" [value]="ratio.value">{{ ratio.label }}</mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
                <mat-form-field class="form-field" appearance="outline">
                  <mat-label>Resolution</mat-label>
                  <input matInput [(ngModel)]="image.resolution" name="imageResolution" placeholder="e.g. 300dpi">
                </mat-form-field>
                <mat-form-field class="form-field" appearance="outline">
                  <mat-label>Format</mat-label>
                  <mat-select [(ngModel)]="image.format" name="imageFormat">
                    <mat-option *ngFor="let fmt of imageFormats" [value]="fmt.value">{{ fmt.label }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
              <div class="form-actions" style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
                <button mat-stroked-button color="primary" type="submit">
                  <mat-icon>save</mat-icon>
                  {{ templateId ? 'Save Changes' : 'Create Template' }}
                </button>
                <button mat-stroked-button color="warn" type="button" (click)="onCancel()">
                  <mat-icon>cancel</mat-icon>
                  Cancel
                </button>
                <button *ngIf="templateId" mat-stroked-button color="warn" type="button" (click)="onDeleteTemplate()">
                  <mat-icon>delete</mat-icon>
                  Delete Template
                </button>
              </div>
            </form>
          </mat-card-content>
        </mat-card>
      </div>
    </ng-container>
    <ng-template #emptyState>
      <div class="empty-state">
        <mat-icon>auto_awesome</mat-icon>
        <h2>No Brand Selected</h2>
        <p>Select a brand to start generating content</p>
      </div>
    </ng-template>
  </div>
</div>
